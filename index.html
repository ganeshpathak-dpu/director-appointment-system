<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Director's Appointment Portal | Dr. D. Y. Patil B-School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{
      box-sizing:border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root{
      --bg:#020617;
      --card:#ffffff;
      --accent:#b91c1c;
      --border:#e5e7eb;
      --text-main:#0f172a;
      --text-muted:#6b7280;
    }

    body{
      margin:0;
      padding:0;
      background:radial-gradient(circle at top left,#b91c1c 0,#0b1120 45%,#020617 100%);
      min-height:100vh;
      color:var(--text-main);
    }

    .page{
      max-width:1150px;
      margin:0 auto;
      padding:18px 16px 24px;
    }

    /******** HEADER ********/
    .header-card{
      background:linear-gradient(130deg,rgba(185,28,28,0.94),rgba(15,23,42,0.96));
      padding:14px 18px 16px;
      border-radius:22px;
      color:white;
      box-shadow:0 20px 40px rgba(15,23,42,0.85);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }

    .header-logo-wrap{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .header-logo-box{
      background:white;
      border-radius:14px;
      padding:6px 10px;
      box-shadow:0 6px 14px rgba(15,23,42,0.4);
    }

    .header-logo-box img{
      height:52px;
      display:block;
    }

    .header-title-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .header-institute{
      font-size:0.78rem;
      letter-spacing:0.08em;
      text-transform:uppercase;
      opacity:0.9;
    }

    .header-main-title{
      margin:0;
      font-size:1.4rem;
      line-height:1.2;
    }

    .header-bottom{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .role-area{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.8rem;
    }

    .role-switch{
      display:inline-flex;
      background:rgba(15,23,42,0.45);
      border-radius:999px;
      padding:3px;
    }

    .role-pill{
      border:none;
      background:transparent;
      padding:5px 14px;
      color:#e5e7eb;
      font-size:0.75rem;
      border-radius:999px;
      opacity:0.7;
      cursor:pointer;
      transition:all 0.15s;
    }
    .role-pill.active{
      background:white;
      color:#b91c1c;
      opacity:1;
      box-shadow:0 4px 10px rgba(15,23,42,0.45);
    }

    .pin-group{
      display:flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,0.35);
      padding:5px 8px;
      border-radius:999px;
    }

    .pin-input{
      border:none;
      border-radius:999px;
      padding:5px 10px;
      min-width:140px;
      font-size:0.76rem;
      outline:none;
    }

    .btn-small{
      background:white;
      border:none;
      padding:5px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:0.76rem;
      font-weight:600;
      color:#b91c1c;
      box-shadow:0 4px 8px rgba(0,0,0,0.25);
      transition:transform 0.08s, box-shadow 0.12s;
    }
    .btn-small:active{
      transform:scale(0.97);
      box-shadow:0 2px 4px rgba(0,0,0,0.4);
    }

    /******** LAYOUT ********/
    .layout{
      display:grid;
      grid-template-columns:1.8fr 1.8fr;
      gap:14px;
      margin-top:18px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
      .header-bottom{justify-content:flex-start;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px 14px 16px;
      box-shadow:0 10px 26px rgba(15,23,42,0.25);
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .card-title h2{margin:0;font-size:1rem;}
    .tag{
      background:#fee2e2;
      color:#b91c1c;
      padding:3px 8px;
      border-radius:999px;
      font-size:0.7rem;
      font-weight:600;
    }

    /******** FORM ********/
    label{
      font-size:0.8rem;
      color:#374151;
    }
    .field{margin-bottom:10px;}

    input,select,textarea{
      width:100%;
      padding:8px 9px;
      border-radius:10px;
      background:#f8fafc;
      border:1px solid #d1d5db;
      font-size:0.85rem;
      outline:none;
      transition:border 0.12s, box-shadow 0.12s, transform 0.08s;
    }
    textarea{min-height:70px;}

    input:focus,select:focus,textarea:focus{
      border-color:#b91c1c;
      box-shadow:0 0 0 1px rgba(185,28,28,0.35);
      transform:translateY(-1px);
      background:white;
    }

    .btn-main{
      background:#b91c1c;
      color:white;
      padding:10px 20px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:600;
      box-shadow:0 10px 24px rgba(185,28,28,0.45);
      transition:transform 0.08s, box-shadow 0.12s;
    }
    .btn-main:active{
      transform:translateY(1px);
      box-shadow:0 6px 16px rgba(185,28,28,0.5);
    }

    .alert{
      margin-top:10px;
      padding:9px 10px;
      border-radius:10px;
      font-size:0.8rem;
      display:none;
    }
    .alert-success{
      background:#dcfce7;
      color:#166534;
    }
    .alert-error{
      background:#fee2e2;
      color:#b91c1c;
    }

    /******** SLOTS ********/
    .slots-box{
      padding:6px;
      border-radius:10px;
      border:1px dashed #d1d5db;
      background:#f9fafb;
    }
    .slots-help{
      font-size:0.72rem;
      color:#6b7280;
      margin:0 0 4px;
    }
    .slots-wrap{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      min-height:34px;
    }

    .slot-pill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #d1d5db;
      cursor:pointer;
      background:#f1f5f9;
      font-size:0.8rem;
      transition:transform 0.08s, box-shadow 0.12s, background 0.12s;
    }
    .slot-pill:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(15,23,42,0.18);
    }
    .slot-pill.selected{
      background:#b91c1c;
      border-color:#b91c1c;
      color:white;
      box-shadow:0 5px 14px rgba(185,28,28,0.55);
    }
    .slot-pill.booked{
      background:#e5e7eb;
      color:#9ca3af;
      border-style:dashed;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .slot-pill.pending{
      background:#fff7ed;
      color:#b45309;
      border-color:#fed7aa;
      cursor:not-allowed;
    }

    /******** TABLES ********/
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px;
      vertical-align:top;
    }
    th{
      background:#f8fafc;
      color:#374151;
      font-size:0.75rem;
      font-weight:600;
    }
    .empty-row{
      text-align:center;
      color:#9ca3af;
      padding:10px 0;
    }

    .status-chip{
      padding:3px 8px;
      border-radius:999px;
      font-size:0.75rem;
      color:white;
    }
    .st-pending{background:#f59e0b;}
    .st-approved{background:#16a34a;}
    .st-rejected{background:#b91c1c;}
    .st-block{background:#6b7280;}

    .badge-urg-normal{
      background:#eff6ff;
      color:#1d4ed8;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
    }
    .badge-urg-urgent{
      background:#fee2e2;
      color:#b91c1c;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
    }

    /* Office panel bio */
    .office-bio{
      margin-top:4px;
      margin-bottom:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:0.78rem;
      color:#374151;
    }
    .office-name{
      font-weight:700;
      font-size:0.85rem;
      color:#111827;
    }
    .office-role{
      font-size:0.78rem;
      color:#4b5563;
    }
    .office-section{
      padding:6px 8px;
      border-radius:10px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
  </style>
</head>

<body>
<div class="page">

  <!-- HEADER -->
  <div class="header-card">

    <div class="header-top">
      <div class="header-logo-wrap">
        <div class="header-logo-box">
          <img src="https://dypbs.edu.in/assets/img/B-school-logo-ver-5.png" alt="DPU Logo" />
        </div>

        <div class="header-title-block">
          <div class="header-institute">DR. D. Y. PATIL B-SCHOOL (DPGU)</div>
          <h1 class="header-main-title">Director's Appointment Portal</h1>
        </div>
      </div>
    </div>

    <div class="header-bottom">
      <div class="role-area">
        <div class="role-switch">
          <button class="role-pill active" data-role="visitor">Visitor</button>
          <button class="role-pill" data-role="ea">EA</button>
          <button class="role-pill" data-role="director">Director</button>
        </div>

        <div class="pin-group">
          <input type="password" id="pinInput" class="pin-input" placeholder="PIN for EA/Director" />
          <button class="btn-small" id="pinApplyBtn">Apply</button>
        </div>
      </div>
    </div>

  </div>

  <!-- LAYOUT -->
  <div class="layout">

    <!-- LEFT PANEL -->
    <section class="card">
      <div class="card-title">
        <h2>Office Panel</h2>
        <span class="tag" id="roleTag">Visitor mode</span>
      </div>

      <div class="office-bio">
        <div class="office-section">
          <div class="office-name">Dr. Raja Roy Choudhury</div>
          <div class="office-role">Director, Dr. D. Y. Patil B-School (DPGU)</div>
          <div class="office-role">DPGU School of Business &amp; Strategy and School of Liberal Arts</div>
        </div>

        <div class="office-section">
          <div class="office-name">Ganesh Pathak</div>
          <div class="office-role">Executive Assistant to Director, Director's Office</div>
          <div class="office-role">Contact: 8421559109 · ganesh.pathak@dpu.edu.in</div>
        </div>
      </div>

      <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
        Use the role switch above to view the portal as a Visitor, Executive Assistant (EA), or Director.
      </p>

      <!-- Director view -->
      <div id="directorPanel" style="display:none;margin-top:8px;">
        <h3 style="margin:6px 0;font-size:0.9rem;">Upcoming Approved Visitors</h3>
        <table>
          <thead>
            <tr><th>When</th><th>Visitor</th><th>Purpose</th></tr>
          </thead>
          <tbody id="directorBody"></tbody>
        </table>
      </div>

      <!-- EA view -->
      <div id="eaPanel" style="display:none;margin-top:8px;">
        <h3 style="margin:6px 0;font-size:0.9rem;">All Visits &amp; Blocked Slots</h3>
        <table>
          <thead>
            <tr>
              <th>Time/Date</th>
              <th>Visitor</th>
              <th>Purpose</th>
              <th>Urgency</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="eaBody"></tbody>
        </table>

        <h3 style="margin-top:14px;font-size:0.9rem;">Block a Slot</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px;">
          <div>
            <label>Date</label>
            <input type="date" id="blockDate" />
          </div>
          <div>
            <label>Time</label>
            <select id="blockTime"><option value="">Select</option></select>
          </div>
          <div style="flex:1;">
            <label>Reason</label>
            <input type="text" id="blockReason" placeholder="Personal / Travel / Meeting" />
          </div>
          <button class="btn-small" id="blockBtn">Block</button>
        </div>
        <div id="blockMsg" class="alert alert-success">Slot blocked successfully.</div>
      </div>
    </section>

    <!-- RIGHT: VISITOR FORM -->
    <section class="card">
      <div class="card-title">
        <h2>Request Appointment</h2>
        <span class="tag">Visitor form</span>
      </div>

      <form id="visitForm">
        <div class="field">
          <label>Select date for appointment *</label>
          <input type="date" id="datePicker" required />
        </div>

        <div class="field">
          <label>Name *</label>
          <input id="visitorName" required />
        </div>
        <div class="field">
          <label>WhatsApp Number *</label>
          <input id="visitorPhone" placeholder="+91XXXXXXXXXX" required />
        </div>
        <div class="field">
          <label>Email *</label>
          <input id="visitorEmail" required />
        </div>
        <div class="field">
          <label>Department / Organisation *</label>
          <input id="visitorDept" required />
        </div>
        <div class="field">
          <label>Urgency *</label>
          <select id="urgency" required>
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>

        <div class="field">
          <label>Available Slots *</label>
          <div class="slots-box">
            <p class="slots-help">
              Slots depend on the selected date. Grey = booked/blocked · Orange = under review · Red = your selection.
            </p>
            <div class="slots-wrap" id="slotContainer"></div>
          </div>
          <input type="hidden" id="selectedSlot" />
        </div>

        <div class="field">
          <label>Purpose *</label>
          <textarea id="purpose" required></textarea>
        </div>

        <button class="btn-main" type="submit">Submit Request</button>

        <div class="alert alert-success" id="formOk">
          Request submitted. You’ll get confirmation on email & WhatsApp.
        </div>
        <div class="alert alert-error" id="formErr">
          Error submitting. Please check fields & try again.
        </div>
      </form>
    </section>

  </div>
</div>

<script>
  const API_URL = "YOUR_WEB_APP_URL_HERE";  // <-- put your Apps Script URL
  const ROLE_PINS = { ea: "1111", director: "2222" };
  const SLOT_LIST = ["10:00","10:30","11:00","11:30","12:00","12:30","13:00"];

  let currentRole="visitor";
  let allItems=[];
  let currentDateKey="";

  async function callApi(params){
    const body=new URLSearchParams(params);
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body
    });
    return res.json();
  }

  async function loadAll(){
    const res=await callApi({action:"listAll"});
    allItems = res.success ? res.data : [];
    renderSlots();
    renderEAList();
    renderDirectorList();
  }

  function setTodayDate(){
    const dp=document.getElementById("datePicker");
    if(!dp) return;
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    currentDateKey=`${y}-${m}-${dd}`;
    dp.value=currentDateKey;
  }

  function getItemsForDate(dateKey){
    return allItems.filter(it=>it.date===dateKey);
  }

  function renderSlots(){
    const cont=document.getElementById("slotContainer");
    const selected=document.getElementById("selectedSlot");
    if(!cont || !selected) return;
    cont.innerHTML="";
    selected.value="";

    if(!currentDateKey){
      return;
    }

    const todayItems=getItemsForDate(currentDateKey);
    const map={};
    todayItems.forEach(it=>{
      if(!map[it.time]) map[it.time]=[];
      map[it.time].push(it);
    });

    SLOT_LIST.forEach(time=>{
      const btn=document.createElement("button");
      btn.type="button";
      btn.textContent=time;
      btn.className="slot-pill";

      const items=map[time]||[];
      const blocked=items.some(i=>i.recordType==="block");
      const approved=items.some(i=>i.recordType==="visit" && i.status==="approved");
      const pending=items.some(i=>i.recordType==="visit" && i.status==="pending");

      if(blocked || approved){
        btn.classList.add("booked");
      } else if(pending){
        btn.classList.add("pending");
      } else {
        btn.onclick=()=>{
          selected.value=time;
          Array.from(cont.children).forEach(x=>x.classList.remove("selected"));
          btn.classList.add("selected");
        };
      }

      cont.appendChild(btn);
    });
  }

  function setRole(role){
    currentRole=role;
    document.querySelectorAll(".role-pill").forEach(b=>{
      b.classList.toggle("active", b.dataset.role===role);
    });

    document.getElementById("roleTag").textContent =
      role==="visitor" ? "Visitor mode" :
      role==="ea" ? "Executive Assistant mode" : "Director mode";

    document.getElementById("eaPanel").style.display =
      role==="ea" ? "block" : "none";

    document.getElementById("directorPanel").style.display =
      role==="director" ? "block" : "none";

    renderEAList();
    renderDirectorList();
  }

  function setupRoleControls(){
    document.querySelectorAll(".role-pill").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const role=btn.dataset.role;
        if(role==="visitor"){ setRole("visitor"); return; }

        const pin=document.getElementById("pinInput").value.trim();
        if(role==="ea" && pin===ROLE_PINS.ea) setRole("ea");
        else if(role==="director" && pin===ROLE_PINS.director) setRole("director");
        else alert("Incorrect PIN");
      });
    });

    document.getElementById("pinApplyBtn").onclick=()=>{
      const pin=document.getElementById("pinInput").value.trim();
      if(pin===ROLE_PINS.ea) setRole("ea");
      else if(pin===ROLE_PINS.director) setRole("director");
      else alert("Incorrect PIN");
    };
  }

  function setupVisitorForm(){
    const form=document.getElementById("visitForm");
    const ok=document.getElementById("formOk");
    const err=document.getElementById("formErr");
    if(!form) return;

    form.addEventListener("submit", async ev=>{
      ev.preventDefault();
      ok.style.display=err.style.display="none";

      const dateVal=document.getElementById("datePicker").value;
      const name=document.getElementById("visitorName").value.trim();
      const phone=document.getElementById("visitorPhone").value.trim();
      const email=document.getElementById("visitorEmail").value.trim();
      const dept=document.getElementById("visitorDept").value.trim();
      const urg=document.getElementById("urgency").value;
      const purpose=document.getElementById("purpose").value.trim();
      const time=document.getElementById("selectedSlot").value;

      if(!dateVal||!name||!phone||!email||!dept||!urg||!purpose||!time){
        err.style.display="block";
        return;
      }

      currentDateKey=dateVal;

      const res=await callApi({
        action:"addVisit",
        name,phone,email,dept,urgency:urg,purpose,
        date:currentDateKey,
        time
      });

      if(res.success){
        ok.style.display="block";
        form.reset();
        document.getElementById("selectedSlot").value="";
        currentDateKey=dateVal; // keep same date
        await loadAll();
        document.getElementById("datePicker").value=dateVal;
      } else err.style.display="block";
    });
  }

  function renderEAList(){
    const body=document.getElementById("eaBody");
    if(!body || currentRole!=="ea") return;
    body.innerHTML="";

    if(!allItems.length){
      body.innerHTML=`<tr><td colspan="6" class="empty-row">No records.</td></tr>`;
      return;
    }

    allItems.forEach(it=>{
      const tr=document.createElement("tr");

      const td1=document.createElement("td");
      td1.innerHTML=`${it.time}<br><span style="color:#9ca3af">${it.date}</span>`;

      const td2=document.createElement("td");
      if(it.recordType==="block"){
        td2.innerHTML="<strong>Blocked</strong><br><span style='color:#666'>Director not available</span>";
      } else {
        td2.innerHTML=`<strong>${it.name}</strong><br>${it.department}<br><span style="color:#999">${it.phone}</span>`;
      }

      const td3=document.createElement("td");
      td3.textContent=it.purpose;

      const td4=document.createElement("td");
      td4.innerHTML = it.recordType==="block"
        ? "-"
        : `<span class="${it.urgency==="urgent"?"badge-urg-urgent":"badge-urg-normal"}">${it.urgency}</span>`;

      const td5=document.createElement("td");
      const st=document.createElement("span");
      st.className="status-chip " +
        (it.recordType==="block"?"st-block":
         it.status==="pending"?"st-pending":
         it.status==="approved"?"st-approved":"st-rejected");
      st.textContent= it.recordType==="block"
        ? "Blocked"
        : it.status.charAt(0).toUpperCase()+it.status.slice(1);
      td5.appendChild(st);

      const td6=document.createElement("td");
      if(it.recordType==="visit" && it.status==="pending"){
        td6.innerHTML = `
          <button class="btn-small" style="background:#16a34a;color:white;margin-right:4px;"
            onclick="updateStatus('${it.id}','approved')">Approve</button>
          <button class="btn-small" style="background:#b91c1c;color:white;"
            onclick="updateStatus('${it.id}','rejected')">Reject</button>`;
      }
      else if(it.recordType==="visit" && it.status==="approved"){
        td6.innerHTML = `<button class="btn-small" style="background:#25D366;color:white;"
          onclick="sendWhatsApp('${it.phone}','${it.name}','${it.date}','${it.time}')">WhatsApp</button>`;
      }
      else{
        td6.innerHTML="<span style='color:#999;'>-</span>";
      }

      tr.append(td1,td2,td3,td4,td5,td6);
      body.appendChild(tr);
    });
  }

  async function updateStatus(id,status){
    const res=await callApi({action:"updateStatus",id,status});
    if(res.success){
      await loadAll();
      alert("Updated.");
    } else alert("Failed: " + res.error);
  }

  function sendWhatsApp(phone,name,date,time){
    const clean=(phone||"").replace(/\D/g,'');
    const msg=`Dear ${name}, your appointment with the Director is confirmed on ${date} at ${time}.`;
    const url=`https://wa.me/${clean}?text=${encodeURIComponent(msg)}`;
    window.open(url,"_blank");
  }

  function renderDirectorList(){
    const body=document.getElementById("directorBody");
    if(!body || currentRole!=="director") return;
    body.innerHTML="";

    let today=(new Date()).toISOString().slice(0,10);
    let list=allItems.filter(it=>it.recordType==="visit" && it.status==="approved" && it.date>=today);

    if(!list.length){
      body.innerHTML=`<tr><td colspan="3" class="empty-row">No upcoming visitors.</td></tr>`;
      return;
    }

    list.sort((a,b)=> (a.date+" "+a.time).localeCompare(b.date+" "+b.time));

    list.forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${it.time}<br><span style="color:#999">${it.date}</span></td>
        <td><strong>${it.name}</strong><br>${it.department}<br>
            <span style="color:#999">${it.urgency}</span></td>
        <td>${it.purpose}</td>`;
      body.appendChild(tr);
    });
  }

  function setupBlockControls(){
    SLOT_LIST.forEach(t=>{
      let o=document.createElement("option");
      o.value=o.textContent=t;
      document.getElementById("blockTime").appendChild(o);
    });

    document.getElementById("blockBtn").onclick=async()=>{
      const date=document.getElementById("blockDate").value || currentDateKey;
      const time=document.getElementById("blockTime").value;
      const reason=document.getElementById("blockReason").value || "Not available";

      if(!date||!time){ alert("Select date & time."); return; }

      const res=await callApi({action:"blockSlot",date,time,reason});
      if(res.success){
        document.getElementById("blockMsg").style.display="block";
        await loadAll();
      }
    };
  }

  document.addEventListener("DOMContentLoaded",async()=>{
    setTodayDate();
    setupRoleControls();
    setupVisitorForm();
    setupBlockControls();
    await loadAll();

    const dp=document.getElementById("datePicker");
    if(dp){
      dp.onchange=e=>{
        currentDateKey=e.target.value;
        renderSlots();
      };
    }

    setRole("visitor");
  });
</script>

</body>
</html>
