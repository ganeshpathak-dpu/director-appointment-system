<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Director's Appointment Portal | Dr. D. Y. Patil B-School (DPGU)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Basic, clean styling -->
  <style>
    :root {
      --primary: #b1181b;
      --primary-dark: #8e1417;
      --accent: #f6b024;
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #dc2626;
      --success: #16a34a;
      --pending: #f97316;
      --blocked: #9ca3af;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 14px 30px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #ffffff, #f1f5f9);
      color: var(--text-main);
      padding: 16px;
    }

    .page-shell {
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 14px;
    }

    header img.logo {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 8px 20px rgba(0,0,0,0.16);
      background: #fff;
    }

    .title-block {
      flex: 1;
    }

    .title-block h1 {
      font-size: 1.4rem;
      line-height: 1.3;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .title-block p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .meta-strip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .meta-strip span.highlight {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(177,24,27,0.06);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .frame {
      background: rgba(255,255,255,0.9);
      border-radius: 22px;
      padding: 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.35);
      backdrop-filter: blur(6px);
    }

    /* Role Switch */
    .role-switch {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 18px;
      flex-wrap: wrap;
    }

    .role-toggle {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid var(--border);
      gap: 4px;
    }

    .role-btn {
      border: none;
      background: transparent;
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s, color 0.15s, transform 0.1s;
    }

    .role-btn.active {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      transform: translateY(-1px);
    }

    .role-caption {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .role-caption strong {
      color: var(--primary-dark);
    }

    /* Layout grid */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.7fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    card {
      display: block;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 16px 18px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .badge {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-muted);
      background: #f9fafb;
    }

    .subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* Director card */
    .director-info {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 4px;
    }

    .director-info img {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 10px 22px rgba(15,23,42,0.3);
      background: #fff;
    }

    .director-text h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .director-text p {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .contact-line {
      font-size: 0.78rem;
      margin-top: 6px;
      color: var(--text-main);
    }

    /* Forms */
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 16px;
      margin-top: 8px;
    }

    form .full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="date"],
    select,
    textarea,
    input[type="password"] {
      width: 100%;
      padding: 7px 9px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      outline: none;
      background: #f9fafb;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(177,24,27,0.2);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .inline-options {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .inline-options label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 0;
      font-size: 0.8rem;
      color: var(--text-main);
    }

    .helper-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 16px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(to right, var(--primary-dark), var(--primary));
      color: #fff;
      box-shadow: 0 6px 14px rgba(148,27,29,0.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(148,27,29,0.45);
    }

    .btn-ghost {
      background: #f3f4f6;
      color: var(--text-main);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    .btn-xs {
      padding: 3px 10px;
      font-size: 0.72rem;
      border-radius: 999px;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    /* Slots */
    .slot-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .slot {
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s, color 0.15s, transform 0.1s, border 0.15s;
    }

    .slot.free:hover {
      background: rgba(177,24,27,0.06);
    }

    .slot.selected {
      background: var(--primary);
      border-color: var(--primary-dark);
      color: #fff;
      transform: translateY(-1px);
    }

    .slot.booked,
    .slot.blocked {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #6b7280;
      cursor: not-allowed;
    }

    .slot.pending {
      background: rgba(249,115,22,0.13);
      border-color: var(--pending);
      color: #b45309;
      cursor: not-allowed;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      font-size: 0.74rem;
      color: var(--text-muted);
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .legend-dot.free { background: rgba(177,24,27,0.12); }
    .legend-dot.pending { background: rgba(249,115,22,0.7); }
    .legend-dot.blocked { background: #9ca3af; }
    .legend-dot.booked { background: #111827; }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 6px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      background: #f9fafb;
    }

    tr:nth-child(even) td {
      background: #fdfdfd;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .chip-urg-urgent {
      background: rgba(220,38,38,0.06);
      border-color: rgba(220,38,38,0.4);
      color: #b91c1c;
    }

    .chip-urg-normal {
      background: rgba(22,163,74,0.06);
      border-color: rgba(22,163,74,0.4);
      color: #15803d;
    }

    .chip-status-pending {
      background: rgba(249,115,22,0.06);
      border-color: rgba(249,115,22,0.5);
      color: #b45309;
    }

    .chip-status-approved {
      background: rgba(22,163,74,0.08);
      border-color: rgba(22,163,74,0.5);
      color: #166534;
    }

    .chip-status-rejected {
      background: rgba(220,38,38,0.08);
      border-color: rgba(220,38,38,0.5);
      color: #b91c1c;
    }

    .chip-status-blocked {
      background: rgba(107,114,128,0.1);
      border-color: rgba(107,114,128,0.6);
      color: #374151;
    }

    /* Messages */
    .msg {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
    }

    .msg-success {
      background: rgba(22,163,74,0.06);
      border: 1px solid rgba(22,163,74,0.4);
      color: #166534;
    }

    .msg-error {
      background: rgba(220,38,38,0.06);
      border: 1px solid rgba(220,38,38,0.4);
      color: #b91c1c;
    }

    .msg-info {
      background: rgba(59,130,246,0.06);
      border: 1px solid rgba(59,130,246,0.4);
      color: #1d4ed8;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 2px;
      color: var(--text-main);
    }

    .small-label {
      font-size: 0.77rem;
      color: var(--text-muted);
    }

    .mt-4 { margin-top: 16px; }
    .mt-2 { margin-top: 8px; }
    .mb-1 { margin-bottom: 4px; }

    .flex {
      display: flex;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .gap-2 { gap: 8px; }
    .justify-end { justify-content: flex-end; }
  </style>
</head>

<body>
  <div class="page-shell">
    <header>
      <!-- TODO: replace src with your official logo path if available -->
      <img class="logo" src="https://via.placeholder.com/64" alt="DPGU Logo" />
      <div class="title-block">
        <h1>DR. D. Y. PATIL B-SCHOOL (DPGU)</h1>
        <p>Director's Appointment Portal · Director's Office</p>
      </div>
    </header>

    <div class="meta-strip">
      <span class="highlight">Director & Executive Assistant Appointment Management</span>
      <span id="todayLabel"></span>
    </div>

    <div class="frame">
      <!-- Role switch -->
      <div class="role-switch">
        <div class="role-toggle">
          <button class="role-btn active" data-role="visitor">Visitor</button>
          <button class="role-btn" data-role="ea">Executive Assistant (EA)</button>
          <button class="role-btn" data-role="director">Director</button>
        </div>
        <div class="role-caption">
          View as: <strong id="roleCaption">Visitor</strong>.
          EA & Director login with PIN for approvals and schedule view.
        </div>
      </div>

      <div class="grid">
        <!-- LEFT COLUMN: Visitor Form / EA Panel / Director Panel -->
        <div id="leftPanel">
          <!-- VISITOR PANEL -->
          <card id="visitorPanel">
            <div class="card-header">
              <div>
                <div class="card-title">Request Appointment</div>
                <p class="subtext">Visitor mode · Your request goes to Director's Office for approval.</p>
              </div>
              <span class="badge">Step 1 · Visitor</span>
            </div>

            <form id="visitorForm">
              <div class="full">
                <label for="visitDate">Select date for appointment *</label>
                <input type="date" id="visitDate" required />
              </div>

              <div>
                <label for="visitorName">Name *</label>
                <input type="text" id="visitorName" required />
              </div>

              <div>
                <label for="visitorPhone">WhatsApp Number *</label>
                <input type="tel" id="visitorPhone" required />
              </div>

              <div>
                <label for="visitorEmail">Email *</label>
                <input type="email" id="visitorEmail" required />
              </div>

              <div>
                <label for="visitorDept">Department / Organisation *</label>
                <input type="text" id="visitorDept" required />
              </div>

              <div>
                <label>Urgency *</label>
                <div class="inline-options">
                  <label><input type="radio" name="urgency" value="Normal" checked /> Normal</label>
                  <label><input type="radio" name="urgency" value="Urgent" /> Urgent</label>
                </div>
              </div>

              <div class="full">
                <label>Available Slots *</label>
                <div id="slotContainer" class="slot-grid"></div>
                <div class="legend">
                  <span><span class="legend-dot free"></span> Free</span>
                  <span><span class="legend-dot pending"></span> Under review</span>
                  <span><span class="legend-dot booked"></span> Approved / booked</span>
                  <span><span class="legend-dot blocked"></span> Blocked</span>
                </div>
                <p class="helper-text">
                  Slots depend on the selected date. Grey = booked/blocked · Orange = under review ·
                  Red = your current selection.
                </p>
                <input type="hidden" id="selectedSlot" />
              </div>

              <div class="full">
                <label for="visitorPurpose">Purpose *</label>
                <textarea id="visitorPurpose" required></textarea>
              </div>

              <div class="full flex justify-end gap-2">
                <button type="reset" class="btn btn-ghost">Clear</button>
                <button type="submit" class="btn btn-primary">
                  Submit Request
                </button>
              </div>
            </form>

            <div id="visitorMessage" class="msg msg-info" style="display:none;"></div>
          </card>

          <!-- EA PANEL -->
          <card id="eaPanel" style="display:none;">
            <div class="card-header">
              <div>
                <div class="card-title">Executive Assistant · Approvals & Slots</div>
                <p class="subtext">Login with EA PIN to manage visitor requests and block slots.</p>
              </div>
              <span class="badge">Step 2 · EA</span>
            </div>

            <div id="eaLoginSection">
              <label for="eaPin">EA PIN</label>
              <div class="flex gap-2 mt-2">
                <input type="password" id="eaPin" placeholder="Enter EA PIN" />
                <button id="eaLoginBtn" class="btn btn-primary btn-xs">Login</button>
              </div>
              <p class="helper-text mt-2">For demo, EA PIN = <strong>2580</strong> (change in JS for production).</p>
              <div id="eaLoginMsg" class="msg msg-error" style="display:none;"></div>
            </div>

            <div id="eaContent" style="display:none; margin-top:10px;">
              <div class="flex-between mb-1">
                <h3 class="section-title">Pending Requests</h3>
                <button id="eaLogoutBtn" class="btn btn-ghost btn-xs">Logout</button>
              </div>
              <p class="small-label">Approve / reject visitor appointments. Approved slots become visible to Director.</p>
              <div id="pendingTableWrap" class="mt-2"></div>

              <h3 class="section-title mt-4">Block a Slot</h3>
              <p class="small-label">Use this for internal meetings / exams / unavailability.</p>

              <form id="blockForm" class="mt-2">
                <div>
                  <label for="blockDate">Date *</label>
                  <input type="date" id="blockDate" required />
                </div>
                <div>
                  <label for="blockSlot">Time *</label>
                  <select id="blockSlot" required>
                    <!-- Filled by JS -->
                  </select>
                </div>
                <div class="full">
                  <label for="blockReason">Reason *</label>
                  <input type="text" id="blockReason" required />
                </div>
                <div class="full flex justify-end">
                  <button type="submit" class="btn btn-primary btn-xs">Block Slot</button>
                </div>
              </form>
              <div id="blockMsg" class="msg msg-info" style="display:none;"></div>

              <h3 class="section-title mt-4">All Visits & Blocked Slots</h3>
              <div id="allTableWrap" class="mt-2"></div>
            </div>
          </card>

          <!-- DIRECTOR PANEL -->
          <card id="directorPanel" style="display:none;">
            <div class="card-header">
              <div>
                <div class="card-title">Director · Today's Schedule</div>
                <p class="subtext">View approved visitors and blocked slots for the day.</p>
              </div>
              <span class="badge">Step 3 · Director</span>
            </div>

            <div id="directorLoginSection">
              <label for="directorPin">Director PIN</label>
              <div class="flex gap-2 mt-2">
                <input type="password" id="directorPin" placeholder="Enter Director PIN" />
                <button id="directorLoginBtn" class="btn btn-primary btn-xs">Login</button>
              </div>
              <p class="helper-text mt-2">For demo, Director PIN = <strong>9999</strong> (change in JS for production).</p>
              <div id="directorLoginMsg" class="msg msg-error" style="display:none;"></div>
            </div>

            <div id="directorContent" style="display:none; margin-top:10px;">
              <div class="flex-between mb-1">
                <h3 class="section-title">Upcoming Approved Visitors · Today</h3>
                <button id="directorLogoutBtn" class="btn btn-ghost btn-xs">Logout</button>
              </div>
              <p class="small-label" id="directorTodayLabel"></p>
              <div id="todayTableWrap" class="mt-2"></div>

              <h3 class="section-title mt-4">All Approved Visits</h3>
              <div id="approvedTableWrap" class="mt-2"></div>
            </div>
          </card>
        </div>

        <!-- RIGHT COLUMN: Director Info / Summary -->
        <div id="rightPanel">
          <card>
            <div class="card-header">
              <div class="card-title">Director's Office</div>
              <span class="badge">DPGU · Director's Office</span>
            </div>
            <p class="subtext">Visitor mode · View-only information panel.</p>

            <div class="director-info">
              <!-- TODO: replace src with actual director photo URL if available -->
              <img src="https://via.placeholder.com/120x120" alt="Director Photo" />
              <div class="director-text">
                <h3>Dr. Raja Roy Choudhury</h3>
                <p>Director, Dr. D. Y. Patil B-School (DPGU)</p>
                <p>DPGU School of Business &amp; Strategy and School of Liberal Arts</p>
                <p class="contact-line">
                  <strong>Executive Assistant:</strong> Ganesh Pathak · 8421559109 ·
                  ganesh.pathak@dpu.edu.in
                </p>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="section-title">How the portal works</h3>
              <ul class="helper-text" style="margin-left:18px; margin-top:6px; list-style:disc;">
                <li>Visitors submit an appointment request with preferred date and slot.</li>
                <li>Executive Assistant reviews &amp; approves, rejects, or blocks slots.</li>
                <li>Director sees only the final approved schedule and blocked slots.</li>
              </ul>
            </div>
          </card>

          <card class="mt-4">
            <div class="card-header">
              <div class="card-title">Quick Stats (Local Browser Only)</div>
              <span class="badge">Demo mode</span>
            </div>
            <div id="statsWrap" class="helper-text">
              <!-- Filled by JS -->
            </div>
          </card>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // CONFIG & DATA MODEL
    // ---------------------------
    const TIME_SLOTS = [
      "10:00 - 10:15",
      "10:15 - 10:30",
      "10:30 - 10:45",
      "10:45 - 11:00",
      "11:00 - 11:15",
      "11:15 - 11:30",
      "11:30 - 11:45",
      "11:45 - 12:00",
      "12:00 - 12:15",
      "12:15 - 12:30",
      "12:30 - 12:45",
      "12:45 - 13:00"
    ];

    const EA_PIN = "2580";        // CHANGE for real use
    const DIRECTOR_PIN = "9999";  // CHANGE for real use

    const STORAGE_KEY = "director_portal_data_v1";

    let state = {
      appointments: [],   // {id, date, slot, name, phone, email, dept, urgency, purpose, status, createdAt}
      blockedSlots: []    // {id, date, slot, reason, createdAt}
    };

    let currentRole = "visitor";
    let selectedSlot = null;
    let eaLoggedIn = false;
    let directorLoggedIn = false;

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      renderAll();
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          state.appointments = parsed.appointments || [];
          state.blockedSlots = parsed.blockedSlots || [];
        }
      } catch (e) {
        console.warn("Error parsing saved data", e);
      }
    }

    function formatDateLabel(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString("en-IN", { weekday: "short", day: "2-digit", month: "short", year: "numeric" });
    }

    function todayISO() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function generateId(prefix) {
      return prefix + "_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
    }

    // ---------------------------
    // ROLE SWITCH UI
    // ---------------------------
    function setRole(role) {
      currentRole = role;
      document.querySelectorAll(".role-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.role === role);
      });
      document.getElementById("roleCaption").textContent =
        role === "visitor" ? "Visitor"
        : role === "ea" ? "Executive Assistant (EA)"
        : "Director";

      document.getElementById("visitorPanel").style.display = (role === "visitor") ? "block" : "none";
      document.getElementById("eaPanel").style.display = (role === "ea") ? "block" : "none";
      document.getElementById("directorPanel").style.display = (role === "director") ? "block" : "none";
    }

    // ---------------------------
    // SLOT STATUS
    // ---------------------------
    function getSlotStatus(date, slot) {
      // Blocked?
      if (state.blockedSlots.some(b => b.date === date && b.slot === slot)) {
        return "blocked";
      }
      // Appointments
      const forSlot = state.appointments.filter(a => a.date === date && a.slot === slot);
      if (forSlot.some(a => a.status === "approved")) {
        return "booked";
      }
      if (forSlot.some(a => a.status === "pending")) {
        return "pending";
      }
      return "free";
    }

    function renderSlots() {
      const dateInput = document.getElementById("visitDate");
      const container = document.getElementById("slotContainer");
      const hiddenSlot = document.getElementById("selectedSlot");

      container.innerHTML = "";
      const date = dateInput.value;
      if (!date) {
        container.innerHTML = '<span class="helper-text">Select a date first to see slots.</span>';
        return;
      }
      selectedSlot = hiddenSlot.value || null;

      TIME_SLOTS.forEach(slot => {
        const status = getSlotStatus(date, slot);
        const span = document.createElement("span");
        span.textContent = slot;
        span.classList.add("slot", status);

        if (status === "free") {
          span.classList.add("free");
          span.addEventListener("click", () => {
            selectedSlot = slot;
            hiddenSlot.value = slot;
            document.querySelectorAll(".slot.free, .slot.selected").forEach(s => s.classList.remove("selected"));
            span.classList.add("selected");
          });
        } else if (status === "pending") {
          span.classList.add("pending");
        } else if (status === "booked") {
          span.classList.add("booked");
        } else if (status === "blocked") {
          span.classList.add("blocked");
        }

        if (slot === selectedSlot && status === "free") {
          span.classList.add("selected");
        }

        container.appendChild(span);
      });
    }

    // ---------------------------
    // VISITOR FORM
    // ---------------------------
    function handleVisitorSubmit(event) {
      event.preventDefault();
      const msgBox = document.getElementById("visitorMessage");
      msgBox.style.display = "none";

      const date = document.getElementById("visitDate").value;
      const name = document.getElementById("visitorName").value.trim();
      const phone = document.getElementById("visitorPhone").value.trim();
      const email = document.getElementById("visitorEmail").value.trim();
      const dept = document.getElementById("visitorDept").value.trim();
      const purpose = document.getElementById("visitorPurpose").value.trim();
      const slot = document.getElementById("selectedSlot").value;
      const urgency = (document.querySelector('input[name="urgency"]:checked') || {}).value || "Normal";

      if (!date || !name || !phone || !email || !dept || !purpose || !slot) {
        msgBox.textContent = "Please fill all required fields and select a slot.";
        msgBox.className = "msg msg-error";
        msgBox.style.display = "block";
        return;
      }

      const status = getSlotStatus(date, slot);
      if (status !== "free") {
        msgBox.textContent = "This slot is no longer available. Please choose another slot.";
        msgBox.className = "msg msg-error";
        msgBox.style.display = "block";
        renderSlots();
        return;
      }

      const appointment = {
        id: generateId("apt"),
        date,
        slot,
        name,
        phone,
        email,
        dept,
        purpose,
        urgency,
        status: "pending",
        createdAt: new Date().toISOString()
      };

      state.appointments.push(appointment);
      saveState();

      msgBox.textContent = "Request submitted successfully. You will get confirmation on email & WhatsApp after approval.";
      msgBox.className = "msg msg-success";
      msgBox.style.display = "block";

      // Reset form, but keep selected date to see under-review slot
      document.getElementById("visitorForm").reset();
      document.getElementById("visitDate").value = date;
      document.getElementById("selectedSlot").value = "";
      selectedSlot = null;
      renderSlots();
    }

    // ---------------------------
    // EA PANEL
    // ---------------------------
    function renderPendingTable() {
      const wrap = document.getElementById("pendingTableWrap");
      const pending = state.appointments.filter(a => a.status === "pending")
        .sort((a,b) => (a.date + a.slot).localeCompare(b.date + b.slot));

      if (!pending.length) {
        wrap.innerHTML = '<div class="msg msg-info">No pending requests.</div>';
        return;
      }

      let html = "<table><thead><tr>" +
        "<th>When</th><th>Visitor</th><th>Purpose</th><th>Urgency</th><th>Actions</th></tr></thead><tbody>";

      pending.forEach(a => {
        html += `<tr>
          <td><strong>${formatDateLabel(a.date)}</strong><br><span class="small-label">${a.slot}</span></td>
          <td><strong>${a.name}</strong><br><span class="small-label">${a.dept}</span><br><span class="small-label">${a.phone}</span></td>
          <td>${a.purpose}</td>
          <td><span class="chip ${
            a.urgency === "Urgent" ? "chip-urg-urgent" : "chip-urg-normal"
          }">${a.urgency}</span></td>
          <td>
            <button class="btn btn-success btn-xs" onclick="approveAppointment('${a.id}')">Approve</button>
            <button class="btn btn-danger btn-xs" style="margin-top:4px;" onclick="rejectAppointment('${a.id}')">Reject</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      wrap.innerHTML = html;
    }

    function renderAllVisitsTable() {
      const wrap = document.getElementById("allTableWrap");
      const allItems = [];

      state.appointments.forEach(a => {
        allItems.push({
          type: "appointment",
          date: a.date,
          slot: a.slot,
          label: a.name,
          extra: a,
          sortKey: a.date + a.slot + "apt"
        });
      });

      state.blockedSlots.forEach(b => {
        allItems.push({
          type: "blocked",
          date: b.date,
          slot: b.slot,
          label: "Blocked",
          extra: b,
          sortKey: b.date + b.slot + "blk"
        });
      });

      if (!allItems.length) {
        wrap.innerHTML = '<div class="msg msg-info">No appointments or blocked slots yet.</div>';
        return;
      }

      allItems.sort((a,b) => a.sortKey.localeCompare(b.sortKey));

      let html = "<table><thead><tr>" +
        "<th>When</th><th>Item</th><th>Urgency / Reason</th><th>Status</th></tr></thead><tbody>";

      allItems.forEach(item => {
        if (item.type === "appointment") {
          const a = item.extra;
          html += `<tr>
            <td><strong>${formatDateLabel(a.date)}</strong><br><span class="small-label">${a.slot}</span></td>
            <td><strong>${a.name}</strong><br><span class="small-label">${a.dept}</span></td>
            <td>${
              a.urgency
                ? `<span class="chip ${
                    a.urgency === "Urgent" ? "chip-urg-urgent" : "chip-urg-normal"
                  }">${a.urgency}</span>`
                : ""
            }</td>
            <td><span class="chip ${
              a.status === "pending" ? "chip-status-pending" :
              a.status === "approved" ? "chip-status-approved" :
              "chip-status-rejected"
            }">${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</span></td>
          </tr>`;
        } else {
          const b = item.extra;
          html += `<tr>
            <td><strong>${formatDateLabel(b.date)}</strong><br><span class="small-label">${b.slot}</span></td>
            <td><strong>Slot Blocked</strong></td>
            <td>${b.reason || ""}</td>
            <td><span class="chip chip-status-blocked">Blocked</span></td>
          </tr>`;
        }
      });

      html += "</tbody></table>";
      wrap.innerHTML = html;
    }

    function approveAppointment(id) {
      const apt = state.appointments.find(a => a.id === id);
      if (!apt) return;
      const status = getSlotStatus(apt.date, apt.slot);
      if (status === "blocked" || status === "booked") {
        alert("Slot is already blocked or booked. Cannot approve.");
        return;
      }
      apt.status = "approved";
      saveState();
    }

    function rejectAppointment(id) {
      const apt = state.appointments.find(a => a.id === id);
      if (!apt) return;
      apt.status = "rejected";
      saveState();
    }

    function handleBlockSubmit(event) {
      event.preventDefault();
      const msgBox = document.getElementById("blockMsg");
      msgBox.style.display = "none";

      const date = document.getElementById("blockDate").value;
      const slot = document.getElementById("blockSlot").value;
      const reason = document.getElementById("blockReason").value.trim();

      if (!date || !slot || !reason) {
        msgBox.textContent = "Please fill all fields.";
        msgBox.className = "msg msg-error";
        msgBox.style.display = "block";
        return;
      }

      const status = getSlotStatus(date, slot);
      if (status === "booked") {
        msgBox.textContent = "Slot already has an approved appointment. Cannot block.";
        msgBox.className = "msg msg-error";
        msgBox.style.display = "block";
        return;
      }

      if (status === "blocked") {
        msgBox.textContent = "This slot is already blocked.";
        msgBox.className = "msg msg-error";
        msgBox.style.display = "block";
        return;
      }

      state.blockedSlots.push({
        id: generateId("blk"),
        date,
        slot,
        reason,
        createdAt: new Date().toISOString()
      });

      saveState();

      msgBox.textContent = "Slot blocked successfully.";
      msgBox.className = "msg msg-success";
      msgBox.style.display = "block";

      document.getElementById("blockForm").reset();
      document.getElementById("blockDate").value = date; // keep date visible
      renderSlots();
    }

    // ---------------------------
    // DIRECTOR PANEL
    // ---------------------------
    function renderTodayForDirector() {
      const today = todayISO();
      const todayWrap = document.getElementById("todayTableWrap");
      const label = document.getElementById("directorTodayLabel");
      label.textContent = "Today: " + formatDateLabel(today);

      const todayApproved = state.appointments
        .filter(a => a.status === "approved" && a.date === today)
        .sort((a,b) => TIME_SLOTS.indexOf(a.slot) - TIME_SLOTS.indexOf(b.slot));

      const todayBlocked = state.blockedSlots
        .filter(b => b.date === today)
        .sort((a,b) => TIME_SLOTS.indexOf(a.slot) - TIME_SLOTS.indexOf(b.slot));

      if (!todayApproved.length && !todayBlocked.length) {
        todayWrap.innerHTML = '<div class="msg msg-info">No approved visitors or blocked slots for today.</div>';
        return;
      }

      let html = "<table><thead><tr>" +
        "<th>Time</th><th>Item</th><th>Details</th></tr></thead><tbody>";

      todayApproved.forEach(a => {
        html += `<tr>
          <td>${a.slot}</td>
          <td><strong>${a.name}</strong><br><span class="small-label">${a.dept}</span></td>
          <td>${a.purpose}<br>${
            a.urgency
              ? `<span class="chip ${
                  a.urgency === "Urgent" ? "chip-urg-urgent" : "chip-urg-normal"
                }" style="margin-top:4px;">${a.urgency}</span>`
              : ""
          }</td>
        </tr>`;
      });

      todayBlocked.forEach(b => {
        html += `<tr>
          <td>${b.slot}</td>
          <td><strong>Blocked Slot</strong></td>
          <td>${b.reason}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      todayWrap.innerHTML = html;
    }

    function renderApprovedForDirector() {
      const wrap = document.getElementById("approvedTableWrap");
      const approved = state.appointments
        .filter(a => a.status === "approved")
        .sort((a,b) => (a.date + a.slot).localeCompare(b.date + b.slot));

      if (!approved.length) {
        wrap.innerHTML = '<div class="msg msg-info">No approved visits yet.</div>';
        return;
      }

      let html = "<table><thead><tr>" +
        "<th>When</th><th>Visitor</th><th>Purpose</th><th>Urgency</th></tr></thead><tbody>";

      approved.forEach(a => {
        html += `<tr>
          <td><strong>${formatDateLabel(a.date)}</strong><br><span class="small-label">${a.slot}</span></td>
          <td><strong>${a.name}</strong><br><span class="small-label">${a.dept}</span></td>
          <td>${a.purpose}</td>
          <td><span class="chip ${
            a.urgency === "Urgent" ? "chip-urg-urgent" : "chip-urg-normal"
          }">${a.urgency}</span></td>
        </tr>`;
      });

      html += "</tbody></table>";
      wrap.innerHTML = html;
    }

    // ---------------------------
    // STATS
    // ---------------------------
    function renderStats() {
      const wrap = document.getElementById("statsWrap");
      const total = state.appointments.length;
      const pending = state.appointments.filter(a => a.status === "pending").length;
      const approved = state.appointments.filter(a => a.status === "approved").length;
      const rejected = state.appointments.filter(a => a.status === "rejected").length;
      const blocked = state.blockedSlots.length;

      wrap.innerHTML = `
        <p>Total appointments (this browser): <strong>${total}</strong></p>
        <p>Pending: <strong>${pending}</strong> · Approved: <strong>${approved}</strong> · Rejected: <strong>${rejected}</strong></p>
        <p>Blocked slots: <strong>${blocked}</strong></p>
        <p class="helper-text mt-2">
          Note: This demo stores data only in this browser using localStorage. For real deployment, use a database (e.g., MySQL/PostgreSQL) and backend API.
        </p>
      `;
    }

    // ---------------------------
    // RENDER ALL
    // ---------------------------
    function renderAll() {
      renderSlots();
      renderPendingTable();
      renderAllVisitsTable();
      renderTodayForDirector();
      renderApprovedForDirector();
      renderStats();
    }

    // ---------------------------
    // INIT
    // ---------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Show today's date
      const now = new Date();
      document.getElementById("todayLabel").textContent =
        now.toLocaleDateString("en-IN", {
          weekday: "short",
          day: "2-digit",
          month: "short",
          year: "numeric"
        }) +
        " · " +
        now.toLocaleTimeString("en-IN", { hour: "2-digit", minute: "2-digit" });

      // Default visit date = today
      document.getElementById("visitDate").value = todayISO();

      // Fill block slot dropdown
      const blockSlotSelect = document.getElementById("blockSlot");
      TIME_SLOTS.forEach(slot => {
        const opt = document.createElement("option");
        opt.value = slot;
        opt.textContent = slot;
        blockSlotSelect.appendChild(opt);
      });

      // Load saved data
      loadState();

      // Role switch
      document.querySelectorAll(".role-btn").forEach(btn => {
        btn.addEventListener("click", () => setRole(btn.dataset.role));
      });

      // Visitor events
      document.getElementById("visitDate").addEventListener("change", renderSlots);
      document.getElementById("visitorForm").addEventListener("submit", handleVisitorSubmit);

      // EA login
      document.getElementById("eaLoginBtn").addEventListener("click", () => {
        const pin = document.getElementById("eaPin").value;
        const msg = document.getElementById("eaLoginMsg");
        if (pin === EA_PIN) {
          eaLoggedIn = true;
          document.getElementById("eaLoginSection").style.display = "none";
          document.getElementById("eaContent").style.display = "block";
          msg.style.display = "none";
        } else {
          msg.textContent = "Incorrect EA PIN.";
          msg.className = "msg msg-error";
          msg.style.display = "block";
        }
      });

      document.getElementById("eaLogoutBtn").addEventListener("click", () => {
        eaLoggedIn = false;
        document.getElementById("eaPin").value = "";
        document.getElementById("eaContent").style.display = "none";
        document.getElementById("eaLoginSection").style.display = "block";
      });

      document.getElementById("blockForm").addEventListener("submit", handleBlockSubmit);

      // Director login
      document.getElementById("directorLoginBtn").addEventListener("click", () => {
        const pin = document.getElementById("directorPin").value;
        const msg = document.getElementById("directorLoginMsg");
        if (pin === DIRECTOR_PIN) {
          directorLoggedIn = true;
          document.getElementById("directorLoginSection").style.display = "none";
          document.getElementById("directorContent").style.display = "block";
          msg.style.display = "none";
          renderTodayForDirector();
          renderApprovedForDirector();
        } else {
          msg.textContent = "Incorrect Director PIN.";
          msg.className = "msg msg-error";
          msg.style.display = "block";
        }
      });

      document.getElementById("directorLogoutBtn").addEventListener("click", () => {
        directorLoggedIn = false;
        document.getElementById("directorPin").value = "";
        document.getElementById("directorContent").style.display = "none";
        document.getElementById("directorLoginSection").style.display = "block";
      });

      // Initial render
      setRole("visitor");
      renderAll();
    });

    // Expose some functions for inline onclick
    window.approveAppointment = approveAppointment;
    window.rejectAppointment = rejectAppointment;
  </script>
</body>
</html>
