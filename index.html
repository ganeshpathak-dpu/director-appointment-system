<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Director's Appointment Portal | Dr. D. Y. Patil B-School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{
      box-sizing:border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root{
      --bg:#0b1120;
      --card:#ffffff;
      --accent:#b91c1c;   /* DYP Red */
      --border:#e5e7eb;
      --text-main:#0f172a;
      --text-muted:#6b7280;
    }

    body{
      margin:0;
      padding:0;
      background:radial-gradient(circle at top left,#b91c1c 0,#0b1120 45%,#020617 100%);
      min-height:100vh;
      color:var(--text-main);
    }

    .page{max-width:1150px;margin:0 auto;padding:16px;}

    /******** HEADER ********/
    .header-card{
      background:linear-gradient(135deg,rgba(185,28,28,0.96),rgba(15,23,42,0.92));
      padding:14px 18px;
      border-radius:12px;
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      box-shadow:0 16px 32px rgba(15,23,42,0.7);
    }

    .role-area{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color:white;
    }

    .role-switch{
      display:inline-flex;
      background:rgba(255,255,255,0.15);
      border-radius:999px;
      padding:3px;
    }

    .role-pill{
      border:none;
      background:transparent;
      padding:5px 12px;
      color:white;
      font-size:0.75rem;
      border-radius:999px;
      opacity:0.7;
      cursor:pointer;
    }

    .role-pill.active{
      background:white;
      color:#b91c1c;
      opacity:1;
    }

    .pin-input{
      border:none;
      border-radius:999px;
      padding:5px 10px;
      min-width:120px;
      font-size:0.75rem;
    }

    .btn-small{
      background:white;
      border:none;
      padding:5px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:0.75rem;
      font-weight:600;
      color:#b91c1c;
    }

    /******** LAYOUT ********/
    .layout{
      display:grid;
      grid-template-columns:1.8fr 1.8fr;
      gap:14px;
      margin-top:18px;
    }

    @media(max-width:850px){
      .layout{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .card-title h2{margin:0;font-size:1rem;}
    .tag{
      background:#fee2e2;
      color:#b91c1c;
      padding:3px 8px;
      border-radius:999px;
      font-size:0.7rem;
    }

    /******** FORM ********/
    label{
      font-size:0.8rem;
      color:#374151;
    }
    .field{
      margin-bottom:10px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      border-radius:6px;
      background:#f8fafc;
      border:1px solid #d1d5db;
      font-size:0.85rem;
    }
    textarea{min-height:70px;}

    .btn-main{
      background:#b91c1c;
      color:white;
      padding:10px 20px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:600;
      box-shadow:0 8px 20px rgba(185,28,28,0.3);
    }

    .alert{
      margin-top:10px;
      padding:10px;
      border-radius:8px;
      font-size:0.8rem;
      display:none;
    }

    .alert-success{
      background:#dcfce7;
      color:#166534;
    }
    .alert-error{
      background:#fee2e2;
      color:#b91c1c;
    }

    /******** SLOTS ********/
    .slots-wrap{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .slot-pill{
      padding:6px 12px;
      border:1px solid #d1d5db;
      border-radius:999px;
      cursor:pointer;
      background:#f1f5f9;
      font-size:0.8rem;
    }
    .slot-pill.selected{
      background:#b91c1c;
      border-color:#b91c1c;
      color:white;
    }
    .slot-pill.booked{
      background:#e5e7eb;
      color:#9ca3af;
      border-style:dashed;
      cursor:not-allowed;
    }
    .slot-pill.pending{
      background:#fff7ed;
      color:#b45309;
      border-color:#fed7aa;
      cursor:not-allowed;
    }

    /******** TABLES ********/
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      padding:6px;
      vertical-align:top;
    }
    th{
      background:#f8fafc;
      color:#374151;
      font-size:0.75rem;
      font-weight:600;
    }
    .empty-row{
      text-align:center;
      color:#9ca3af;
      padding:10px 0;
    }

    .status-chip{
      padding:3px 8px;
      border-radius:999px;
      font-size:0.75rem;
      color:white;
    }

    .st-pending{background:#f59e0b;}
    .st-approved{background:#16a34a;}
    .st-rejected{background:#b91c1c;}
    .st-block{background:#6b7280;}

    .badge-urg-normal{
      background:#eff6ff;
      color:#1d4ed8;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
    }
    .badge-urg-urgent{
      background:#fee2e2;
      color:#b91c1c;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.75rem;
    }
  </style>
</head>

<body>

<div class="page">

  <!-- HEADER -->
  <div class="header-card">

    <!-- LEFT: BRANDING -->
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
      <img src="https://dypbs.edu.in/assets/img/B-school-logo-ver-5.png"
           alt="DPU Logo"
           style="height:55px;background:white;border-radius:6px;padding:4px;" />

      <div>
        <div style="font-size:0.75rem;text-transform:uppercase;opacity:0.9;">
          Dr. D. Y. Patil B-School (DPGU)
        </div>
        <h1 style="margin:0;font-size:1.35rem;">Director's Appointment Portal</h1>
        <p style="margin:2px 0 0;font-size:0.8rem;opacity:0.9;">
          Office of the Director · Pune
        </p>
      </div>
    </div>

    <!-- RIGHT: ROLES -->
    <div class="role-area">

      <div style="background:rgba(255,255,255,0.15);padding:5px 10px;border-radius:999px;">
        Date: <input type="date" id="datePicker" style="border-radius:6px;border:none;padding:4px;" />
      </div>

      <div class="role-switch">
        <button class="role-pill active" data-role="visitor">Visitor</button>
        <button class="role-pill" data-role="ea">EA</button>
        <button class="role-pill" data-role="director">Director</button>
      </div>

      <input type="password" id="pinInput" class="pin-input" placeholder="PIN" />
      <button class="btn-small" id="pinApplyBtn">Apply</button>

    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout">

    <!-- LEFT PANEL -->
    <section class="card">

      <div class="card-title">
        <h2>Office Panel</h2>
        <span class="tag" id="roleTag">Visitor mode</span>
      </div>

      <p style="font-size:0.75rem;color:var(--text-muted);">
        EA can approve/reject requests & block time. Director sees upcoming approved appointments only.
      </p>

      <!-- DIRECTOR PANEL -->
      <div id="directorPanel" style="display:none;">
        <h3 style="margin:8px 0;font-size:0.9rem;">Upcoming Approved Visitors</h3>
        <table>
          <thead>
            <tr>
              <th>When</th>
              <th>Visitor</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody id="directorBody"></tbody>
        </table>
      </div>

      <!-- EA PANEL -->
      <div id="eaPanel" style="display:none;">
        <h3 style="font-size:0.9rem;margin:8px 0;">All Visits & Blocked Slots</h3>

        <table>
          <thead>
            <tr>
              <th>Time/Date</th>
              <th>Visitor</th>
              <th>Purpose</th>
              <th>Urgency</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="eaBody"></tbody>
        </table>

        <h3 style="margin-top:16px;font-size:0.9rem;">Block a Slot</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px;">
          <div>
            <label>Date</label>
            <input type="date" id="blockDate" />
          </div>
          <div>
            <label>Time</label>
            <select id="blockTime">
              <option value="">Select</option>
            </select>
          </div>
          <div style="flex:1;">
            <label>Reason</label>
            <input type="text" id="blockReason" placeholder="Personal/Travel/etc." />
          </div>
          <button class="btn-small" id="blockBtn">Block</button>
        </div>
        <div id="blockMsg" class="alert alert-success">Slot blocked successfully.</div>
      </div>

      <!-- VISITOR INFO -->
      <div id="visitorInfo">
        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:6px;">
          Please use the form to request an appointment with the Director.
        </p>
      </div>

    </section>

    <!-- RIGHT: VISITOR FORM -->
    <section class="card">
      <div class="card-title">
        <h2>Request Appointment</h2>
        <span class="tag">Visitor form</span>
      </div>

      <form id="visitForm">
        <div class="field">
          <label>Name *</label>
          <input id="visitorName" required />
        </div>

        <div class="field">
          <label>WhatsApp Number *</label>
          <input id="visitorPhone" placeholder="+91XXXXXXXXXX" required />
        </div>

        <div class="field">
          <label>Email *</label>
          <input id="visitorEmail" required />
        </div>

        <div class="field">
          <label>Department / Organisation *</label>
          <input id="visitorDept" required />
        </div>

        <div class="field">
          <label>Urgency *</label>
          <select id="urgency" required>
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>

        <div class="field">
          <label>Available Slots *</label>
          <div class="slots-wrap" id="slotContainer"></div>
          <input type="hidden" id="selectedSlot" />
        </div>

        <div class="field">
          <label>Purpose *</label>
          <textarea id="purpose" required></textarea>
        </div>

        <button class="btn-main" type="submit">Submit Request</button>

        <div class="alert alert-success" id="formOk">
          Request submitted. You’ll get confirmation on email & WhatsApp.
        </div>
        <div class="alert alert-error" id="formErr">
          Error. Please check fields & try again.
        </div>
      </form>
    </section>

  </div>
</div>


<!-- BEGIN FULL JS LOGIC -->
<script>

  const API_URL = "YOUR_WEB_APP_URL_HERE";  
  const ROLE_PINS = { ea: "1111", director: "2222" };
  const SLOT_LIST = ["10:00","10:30","11:00","11:30","12:00","12:30","13:00"];

  let currentRole="visitor";
  let allItems=[];
  let currentDateKey="";

  async function callApi(params){
    const body=new URLSearchParams(params);
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body
    });
    return res.json();
  }

  async function loadAll(){
    const res = await callApi({action:"listAll"});
    allItems = res.success ? res.data : [];
    renderSlots();
    renderEAList();
    renderDirectorList();
  }

  function setTodayDate(){
    const dp=document.getElementById("datePicker");
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    currentDateKey=`${y}-${m}-${dd}`;
    dp.value=currentDateKey;
  }

  function getItemsForDate(dateKey){
    return allItems.filter(it=>it.date===dateKey);
  }

  function renderSlots(){
    const cont=document.getElementById("slotContainer");
    const selected=document.getElementById("selectedSlot");
    cont.innerHTML="";
    selected.value="";

    const todayItems=getItemsForDate(currentDateKey);

    const map={};
    todayItems.forEach(it=>{
      if(!map[it.time]) map[it.time]=[];
      map[it.time].push(it);
    });

    SLOT_LIST.forEach(time=>{
      const btn=document.createElement("button");
      btn.type="button";
      btn.textContent=time;
      btn.className="slot-pill";

      const items=map[time]||[];
      const blocked=items.some(i=>i.recordType==="block");
      const approved=items.some(i=>i.recordType==="visit" && i.status==="approved");
      const pending=items.some(i=>i.recordType==="visit" && i.status==="pending");

      if(blocked || approved){
        btn.classList.add("booked");
      } else if(pending) {
        btn.classList.add("pending");
      } else {
        btn.onclick=()=>{
          selected.value=time;
          Array.from(cont.children).forEach(x=>x.classList.remove("selected"));
          btn.classList.add("selected");
        };
      }

      cont.appendChild(btn);
    });
  }

  function setRole(role){
    currentRole=role;
    document.querySelectorAll(".role-pill").forEach(b=>{
      b.classList.toggle("active", b.dataset.role===role);
    });

    document.getElementById("roleTag").textContent =
      role==="visitor" ? "Visitor mode" :
      role==="ea" ? "Executive Assistant mode" : "Director mode";

    document.getElementById("visitorInfo").style.display =
      role==="visitor" ? "block" : "none";

    document.getElementById("eaPanel").style.display =
      role==="ea" ? "block" : "none";

    document.getElementById("directorPanel").style.display =
      role==="director" ? "block" : "none";

    renderEAList();
    renderDirectorList();
  }

  function setupRoleControls(){
    document.querySelectorAll(".role-pill").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const role=btn.dataset.role;
        if(role==="visitor"){ setRole("visitor"); return; }

        const pin=document.getElementById("pinInput").value.trim();
        if(role==="ea" && pin===ROLE_PINS.ea) setRole("ea");
        else if(role==="director" && pin===ROLE_PINS.director) setRole("director");
        else alert("Incorrect PIN");
      });
    });

    document.getElementById("pinApplyBtn").onclick=()=>{
      const pin=document.getElementById("pinInput").value.trim();
      if(pin===ROLE_PINS.ea) setRole("ea");
      else if(pin===ROLE_PINS.director) setRole("director");
      else alert("Incorrect PIN");
    };
  }

  function setupVisitorForm(){
    const form=document.getElementById("visitForm");
    const ok=document.getElementById("formOk");
    const err=document.getElementById("formErr");

    form.addEventListener("submit", async ev=>{
      ev.preventDefault();
      ok.style.display=err.style.display="none";

      const name=document.getElementById("visitorName").value.trim();
      const phone=document.getElementById("visitorPhone").value.trim();
      const email=document.getElementById("visitorEmail").value.trim();
      const dept=document.getElementById("visitorDept").value.trim();
      const urg=document.getElementById("urgency").value;
      const purpose=document.getElementById("purpose").value.trim();
      const time=document.getElementById("selectedSlot").value;

      if(!name||!phone||!email||!dept||!urg||!purpose||!time){
        err.style.display="block";
        return;
      }

      const res=await callApi({
        action:"addVisit",
        name,phone,email,dept,urgency:urg,purpose,
        date:currentDateKey,
        time
      });

      if(res.success){
        ok.style.display="block";
        form.reset();
        document.getElementById("selectedSlot").value="";
        await loadAll();
      } else err.style.display="block";
    });
  }

  function renderEAList(){
    const body=document.getElementById("eaBody");
    if(!body || currentRole!=="ea") return;
    body.innerHTML="";

    if(!allItems.length){
      body.innerHTML=`<tr><td colspan="6" class="empty-row">No records.</td></tr>`;
      return;
    }

    allItems.forEach(it=>{
      const tr=document.createElement("tr");

      const td1=document.createElement("td");
      td1.innerHTML=`${it.time}<br><span style="color:#9ca3af">${it.date}</span>`;

      const td2=document.createElement("td");
      if(it.recordType==="block"){
        td2.innerHTML="<strong>Blocked</strong><br><span style='color:#666'>Director not available</span>";
      } else {
        td2.innerHTML=`<strong>${it.name}</strong><br>${it.department}<br><span style="color:#999">${it.phone}</span>`;
      }

      const td3=document.createElement("td");
      td3.textContent=it.purpose;

      const td4=document.createElement("td");
      td4.innerHTML = it.recordType==="block"
        ? "-"
        : `<span class="${it.urgency==="urgent"?"badge-urg-urgent":"badge-urg-normal"}">${it.urgency}</span>`;

      const td5=document.createElement("td");
      const st=document.createElement("span");
      st.className="status-chip " +
        (it.recordType==="block"?"st-block":
         it.status==="pending"?"st-pending":
         it.status==="approved"?"st-approved":"st-rejected");
      st.textContent= it.recordType==="block"
        ? "Blocked"
        : it.status.charAt(0).toUpperCase()+it.status.slice(1);
      td5.appendChild(st);

      const td6=document.createElement("td");
      if(it.recordType==="visit" && it.status==="pending"){
        td6.innerHTML = `
          <button class="btn-small" style="background:#16a34a;color:white;margin-right:4px;"
            onclick="updateStatus('${it.id}','approved')">Approve</button>
          <button class="btn-small" style="background:#b91c1c;color:white;"
            onclick="updateStatus('${it.id}','rejected')">Reject</button>`;
      }
      else if(it.recordType==="visit" && it.status==="approved"){
        td6.innerHTML = `<button class="btn-small" style="background:#25D366;color:white;"
          onclick="sendWhatsApp('${it.phone}','${it.name}','${it.date}','${it.time}')">WhatsApp</button>`;
      }
      else{
        td6.innerHTML="<span style='color:#999;'>-</span>";
      }

      tr.append(td1,td2,td3,td4,td5,td6);
      body.appendChild(tr);
    });
  }

  async function updateStatus(id,status){
    const res=await callApi({action:"updateStatus",id,status});
    if(res.success){
      await loadAll();
      alert("Updated.");
    } else alert("Failed: " + res.error);
  }

  function sendWhatsApp(phone,name,date,time){
    const clean=phone.replace(/\D/g,'');
    const msg=`Dear ${name}, your appointment with the Director is confirmed on ${date} at ${time}.`;
    const url=`https://wa.me/${clean}?text=${encodeURIComponent(msg)}`;
    window.open(url,"_blank");
  }

  function renderDirectorList(){
    const body=document.getElementById("directorBody");
    if(!body || currentRole!=="director") return;
    body.innerHTML="";

    let today=(new Date()).toISOString().slice(0,10);
    let list=allItems.filter(it=>it.recordType==="visit" && it.status==="approved" && it.date>=today);

    if(!list.length){
      body.innerHTML=`<tr><td colspan="3" class="empty-row">No upcoming visitors.</td></tr>`;
      return;
    }

    list.sort((a,b)=> (a.date+" "+a.time).localeCompare(b.date+" "+b.time));

    list.forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${it.time}<br><span style="color:#999">${it.date}</span></td>
        <td><strong>${it.name}</strong><br>${it.department}<br>
            <span style="color:#999">${it.urgency}</span></td>
        <td>${it.purpose}</td>`;
      body.appendChild(tr);
    });
  }

  function setupBlockControls(){
    SLOT_LIST.forEach(t=>{
      let o=document.createElement("option");
      o.value=o.textContent=t;
      document.getElementById("blockTime").appendChild(o);
    });

    document.getElementById("blockBtn").onclick=async()=>{
      const date=document.getElementById("blockDate").value || currentDateKey;
      const time=document.getElementById("blockTime").value;
      const reason=document.getElementById("blockReason").value || "Not available";

      if(!date||!time){ alert("Select date & time."); return; }

      const res=await callApi({action:"blockSlot",date,time,reason});
      if(res.success){
        document.getElementById("blockMsg").style.display="block";
        await loadAll();
      }
    };
  }

  document.addEventListener("DOMContentLoaded",async()=>{
    setTodayDate();
    setupRoleControls();
    setupVisitorForm();
    setupBlockControls();
    await loadAll();

    document.getElementById("datePicker").onchange=e=>{
      currentDateKey=e.target.value;
      renderSlots();
    };
  });

</script>
<!-- END JS -->

</body>
</html>
