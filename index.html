<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Director Appointment System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      margin-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }
    header h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }
    header p {
      margin: 0;
      font-size: 0.85rem;
      color: #4b5563;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .top-bar-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }
    input[type="date"], input[type="time"], input[type="text"], input[type="email"], select, textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 3px;
      display: block;
    }
    .card {
      background: #ffffff;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
    }
    .card h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .subtext {
      margin: 0 0 8px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th, td {
      padding: 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    .empty-text {
      font-size: 0.8rem;
      color: #6b7280;
      padding: 6px 0;
    }
    .btn-main {
      border: none;
      cursor: pointer;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      background: #2563eb;
      color: #fff;
    }
    .btn-main:active {
      transform: scale(0.98);
    }
    .btn-tag {
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-approve {
      background: #16a34a;
      color: #fff;
    }
    .btn-reject {
      background: #dc2626;
      color: #fff;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      color: #fff;
    }
    .status-pending { background: #f59e0b; }
    .status-ea { background: #2563eb; }
    .status-dir { background: #16a34a; }
    .status-rej { background: #b91c1c; }
    .slot-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin: 2px;
      border: 1px solid #d1d5db;
      cursor: pointer;
    }
    .slot-pill.selected {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .slot-pill.booked {
      background: #e5e7eb;
      color: #9ca3af;
      border-style: dashed;
      cursor: not-allowed;
    }
    .role-label {
      font-size: 0.75rem;
      color: #4b5563;
    }
    .role-strong {
      font-weight: 600;
      color: #111827;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .alert {
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-top: 6px;
    }
    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .dashboard-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .dash-box {
      flex: 1 1 120px;
      background: #f9fafb;
      border-radius: 6px;
      padding: 6px;
      font-size: 0.75rem;
      border: 1px solid #e5e7eb;
    }
    .dash-label {
      color: #6b7280;
      margin-bottom: 2px;
    }
    .dash-value {
      font-size: 1rem;
      font-weight: 700;
    }
    @media (max-width: 700px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Director Appointment System</h1>
    <p>Office of the Director – Dr. D. Y. Patil B-School (DPGU)</p>
    <div class="top-bar">
      <div class="top-bar-group">
        <span>Date:</span>
        <input type="date" id="datePicker">
      </div>
      <div class="top-bar-group">
        <span class="role-label">
          Login as:
          <span class="role-strong" id="roleLabel">Visitor</span>
        </span>
        <select id="roleSelect">
          <option value="visitor">Visitor</option>
          <option value="ea">Executive Assistant</option>
          <option value="director">Director</option>
        </select>
        <input type="password" id="rolePin" placeholder="PIN (EA=1111, Dir=2222)" style="width:160px;">
        <button class="btn-main" id="roleBtn" type="button">Set</button>
      </div>
    </div>
  </header>

  <!-- Director Schedule -->
  <section class="card">
    <h2>Director’s Schedule</h2>
    <p class="subtext">
      Read-only view of the Director’s planned meetings for the selected date.
      Appointment requests are booked only in the available slots shown below.
    </p>
    <div id="scheduleEmpty" class="empty-text">No schedule added for this date yet.</div>
    <table>
      <thead>
      <tr>
        <th style="width:20%;">Time</th>
        <th style="width:25%;">Person / Dept</th>
        <th>Agenda</th>
      </tr>
      </thead>
      <tbody id="scheduleBody"></tbody>
    </table>
  </section>

  <!-- Visitor Appointment Form -->
  <section class="card" id="visitorSection">
    <h2>Appointment Request (Visitor)</h2>
    <p class="subtext">
      Please request a meeting only in free slots. You will receive a confirmation email once the Director approves.
    </p>

    <form id="visitorForm">
      <div class="grid-2">
        <div>
          <label for="visitorName">Your full name *</label>
          <input type="text" id="visitorName" required>
        </div>
        <div>
          <label for="visitorEmail">Your email (for confirmation) *</label>
          <input type="email" id="visitorEmail" required>
        </div>
        <div>
          <label for="visitorDept">Department / Organisation *</label>
          <input type="text" id="visitorDept" required>
        </div>
        <div>
          <label for="urgency">Urgency *</label>
          <select id="urgency" required>
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>Available time slots for selected date *</label>
        <div id="slotContainer"></div>
        <input type="hidden" id="selectedSlot">
      </div>

      <div style="margin-top:8px;">
        <label for="purpose">Purpose of meeting *</label>
        <textarea id="purpose" required></textarea>
      </div>

      <button class="btn-main" type="submit" style="margin-top:8px;">Submit Request</button>

      <div id="formSuccess" class="alert alert-success" style="display:none;">
        Your request has been submitted. You will receive an email after approval.
      </div>
      <div id="formError" class="alert alert-error" style="display:none;">
        There was a problem submitting your request. Please check fields and try again.
      </div>
    </form>
  </section>

  <!-- EA / Director section -->
  <section class="card" id="adminSection" style="display:none;">
    <h2>Approval Panel (EA / Director)</h2>
    <p class="subtext">
      Level 1: Executive Assistant approves/rejects incoming requests.  
      Level 2: Director approves/rejects EA-approved requests. Director approvals trigger confirmation emails.
    </p>

    <!-- Director dashboard -->
    <div id="directorDashboard" style="display:none;">
      <h3 style="margin:0 0 4px; font-size:0.9rem;">Director Dashboard – Today</h3>
      <div class="dashboard-row" id="dashRow">
        <!-- Filled via JS -->
      </div>
    </div>

    <table style="margin-top:8px;">
      <thead>
      <tr>
        <th style="width:13%;">Time</th>
        <th style="width:22%;">Visitor</th>
        <th>Purpose</th>
        <th style="width:15%;">Urgency</th>
        <th style="width:16%;">Status</th>
        <th style="width:18%;">Actions</th>
      </tr>
      </thead>
      <tbody id="adminBody"></tbody>
    </table>
  </section>
</div>

<script>
  // ========= CONFIG =========
  const API_URL = "YOUR_WEB_APP_URL_HERE"; // <-- put your Apps Script Web App URL here
  const ROLE_PINS = { ea: "1111", director: "2222" };

  // Time slots (30 min from 10:00–13:00 as example; adjust as you like)
  const SLOT_LIST = [
    "10:00",
    "10:30",
    "11:00",
    "11:30",
    "12:00",
    "12:30",
    "13:00"
  ];

  let currentRole = "visitor";
  let allRequests = [];          // all rows from server
  let currentDateKey = "";       // YYYY-MM-DD
  let selectedSlot = "";

  // ========= UTIL =========
  function toKeyDate(date) {
    const d = new Date(date);
    if (isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  async function apiPost(paramsObj) {
    const body = new URLSearchParams(paramsObj);
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });
    return res.json();
  }

  // ========= SCHEDULE (STATIC DEMO DATA; you can edit or later move to Sheet) =========
  const scheduleData = {};

  function renderSchedule() {
    const body = document.getElementById("scheduleBody");
    const empty = document.getElementById("scheduleEmpty");
    body.innerHTML = "";

    const list = scheduleData[currentDateKey] || [];
    if (!list.length) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    list.forEach(item => {
      const tr = document.createElement("tr");
      const tdTime = document.createElement("td");
      const tdWho = document.createElement("td");
      const tdAgenda = document.createElement("td");
      tdTime.textContent = item.time;
      tdWho.textContent = item.who;
      tdAgenda.textContent = item.agenda;
      tr.appendChild(tdTime);
      tr.appendChild(tdWho);
      tr.appendChild(tdAgenda);
      body.appendChild(tr);
    });
  }

  // ========= ROLES =========
  function updateRoleUI() {
    const label = document.getElementById("roleLabel");
    const adminSection = document.getElementById("adminSection");
    const visitorSection = document.getElementById("visitorSection");
    const directorDashboard = document.getElementById("directorDashboard");

    if (currentRole === "visitor") {
      label.textContent = "Visitor";
      visitorSection.style.display = "block";
      adminSection.style.display = "none";
      directorDashboard.style.display = "none";
    } else if (currentRole === "ea") {
      label.textContent = "Executive Assistant";
      visitorSection.style.display = "block";
      adminSection.style.display = "block";
      directorDashboard.style.display = "none";
    } else if (currentRole === "director") {
      label.textContent = "Director";
      visitorSection.style.display = "block";
      adminSection.style.display = "block";
      directorDashboard.style.display = "block";
    }
    renderAdminTable();
    renderSlots();
    if (currentRole === "director") {
      renderDashboard();
    }
  }

  function setupRoleControls() {
    const btn = document.getElementById("roleBtn");
    btn.addEventListener("click", () => {
      const sel = document.getElementById("roleSelect").value;
      const pin = document.getElementById("rolePin").value.trim();

      if (sel === "visitor") {
        currentRole = "visitor";
        document.getElementById("rolePin").value = "";
        updateRoleUI();
        return;
      }

      const expected = ROLE_PINS[sel];
      if (pin === expected) {
        currentRole = sel;
        document.getElementById("rolePin").value = "";
        updateRoleUI();
      } else {
        alert("Incorrect PIN.");
      }
    });
  }

  // ========= LOAD DATA =========
  async function loadAllRequests() {
    try {
      const res = await apiPost({ action: "get" });
      if (res && res.success && Array.isArray(res.data)) {
        allRequests = res.data;
      } else {
        allRequests = [];
      }
    } catch (err) {
      console.error("Error loading requests", err);
      allRequests = [];
    }
    renderSlots();
    renderAdminTable();
    if (currentRole === "director") {
      renderDashboard();
    }
  }

  function requestsForCurrentDate() {
    return allRequests.filter(r => r.date === currentDateKey);
  }

  // ========= VISITOR SLOTS =========
  function renderSlots() {
    const container = document.getElementById("slotContainer");
    container.innerHTML = "";
    selectedSlot = "";
    document.getElementById("selectedSlot").value = "";

    const dayRequests = requestsForCurrentDate();
    const bookedTimes = new Set(
      dayRequests
        .filter(r => r.status === "directorApproved")
        .map(r => r.time)
    );

    SLOT_LIST.forEach(slot => {
      const pill = document.createElement("span");
      pill.className = "slot-pill";
      pill.textContent = slot;

      if (bookedTimes.has(slot)) {
        pill.classList.add("booked");
      } else {
        pill.addEventListener("click", () => {
          if (pill.classList.contains("booked")) return;
          selectedSlot = slot;
          document.getElementById("selectedSlot").value = slot;
          Array.from(container.children).forEach(ch => ch.classList.remove("selected"));
          pill.classList.add("selected");
        });
      }
      container.appendChild(pill);
    });
  }

  // ========= VISITOR FORM =========
  function setupVisitorForm() {
    const form = document.getElementById("visitorForm");
    const success = document.getElementById("formSuccess");
    const error = document.getElementById("formError");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      success.style.display = "none";
      error.style.display = "none";

      const name = document.getElementById("visitorName").value.trim();
      const email = document.getElementById("visitorEmail").value.trim();
      const dept = document.getElementById("visitorDept").value.trim();
      const urgency = document.getElementById("urgency").value;
      const purpose = document.getElementById("purpose").value.trim();
      const time = document.getElementById("selectedSlot").value;

      if (!name || !email || !dept || !urgency || !purpose || !time) {
        error.style.display = "block";
        return;
      }

      try {
        const res = await apiPost({
          action: "add",
          date: currentDateKey,
          time,
          name,
          dept,
          urgency,
          purpose,
          email
        });

        if (res && res.success) {
          success.style.display = "block";
          form.reset();
          await loadAllRequests(); // refresh slots, admin view
        } else {
          console.error("Add error", res);
          error.style.display = "block";
        }
      } catch (err) {
        console.error("Error submitting", err);
        error.style.display = "block";
      }
    });
  }

  // ========= ADMIN TABLE =========
  function renderAdminTable() {
    const body = document.getElementById("adminBody");
    body.innerHTML = "";
    if (currentRole === "visitor") return;

    const list = requestsForCurrentDate();
    if (!list.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.textContent = "No requests for this date.";
      td.className = "empty-text";
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    list.forEach(req => {
      const tr = document.createElement("tr");

      const tdTime = document.createElement("td");
      tdTime.textContent = req.time || "-";

      const tdVisitor = document.createElement("td");
      tdVisitor.innerHTML =
        "<strong>" + req.name + "</strong><br>" +
        "<span style='font-size:0.7rem;color:#6b7280;'>" + req.dept + "</span><br>" +
        "<span style='font-size:0.7rem;color:#9ca3af;'>" + (req.email || "") + "</span>";

      const tdPurpose = document.createElement("td");
      tdPurpose.textContent = req.purpose;

      const tdUrg = document.createElement("td");
      tdUrg.textContent = req.urgency;

      const tdStatus = document.createElement("td");
      const st = document.createElement("span");
      st.className = "status-badge ";
      if (req.status === "pending") {
        st.classList.add("status-pending");
        st.textContent = "Pending (EA)";
      } else if (req.status === "eaApproved") {
        st.classList.add("status-ea");
        st.textContent = "EA Approved";
      } else if (req.status === "directorApproved") {
        st.classList.add("status-dir");
        st.textContent = "Director Approved";
      } else if (req.status === "rejected") {
        st.classList.add("status-rej");
        st.textContent = "Rejected";
      }
      tdStatus.appendChild(st);

      const tdActions = document.createElement("td");

      const canEA = (currentRole === "ea") && (req.status === "pending");
      const canDir = (currentRole === "director") && (req.status === "eaApproved");

      if (canEA || canDir) {
        const btnA = document.createElement("button");
        btnA.type = "button";
        btnA.className = "btn-tag btn-approve";
        btnA.textContent = "Approve";
        btnA.onclick = () => updateStatus(req.id, currentRole === "ea" ? "eaApproved" : "directorApproved");

        const btnR = document.createElement("button");
        btnR.type = "button";
        btnR.className = "btn-tag btn-reject";
        btnR.textContent = "Reject";
        btnR.onclick = () => updateStatus(req.id, "rejected");

        tdActions.appendChild(btnA);
        tdActions.appendChild(btnR);
      } else {
        tdActions.innerHTML = "<span style='font-size:0.7rem;color:#9ca3af;'>No action</span>";
      }

      tr.appendChild(tdTime);
      tr.appendChild(tdVisitor);
      tr.appendChild(tdPurpose);
      tr.appendChild(tdUrg);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);
      body.appendChild(tr);
    });
  }

  async function updateStatus(id, newStatus) {
    try {
      await apiPost({ action: "update", id, status: newStatus });
      await loadAllRequests();
      alert("Status updated.");
    } catch (err) {
      console.error("Error updating status", err);
      alert("Error updating status. Please try again.");
    }
  }

  // ========= DIRECTOR DASHBOARD =========
  function renderDashboard() {
    const list = requestsForCurrentDate();
    const dashRow = document.getElementById("dashRow");
    dashRow.innerHTML = "";

    let total = list.length;
    let pending = list.filter(r => r.status === "pending").length;
    let eaApproved = list.filter(r => r.status === "eaApproved").length;
    let dirApproved = list.filter(r => r.status === "directorApproved").length;
    let rejected = list.filter(r => r.status === "rejected").length;
    let urgent = list.filter(r => r.urgency === "urgent").length;

    function addBox(label, value) {
      const box = document.createElement("div");
      box.className = "dash-box";
      const l = document.createElement("div");
      l.className = "dash-label";
      l.textContent = label;
      const v = document.createElement("div");
      v.className = "dash-value";
      v.textContent = value;
      box.appendChild(l);
      box.appendChild(v);
      dashRow.appendChild(box);
    }

    addBox("Total requests", total);
    addBox("Pending (EA)", pending);
    addBox("EA approved", eaApproved);
    addBox("Director approved", dirApproved);
    addBox("Rejected", rejected);
    addBox("Urgent", urgent);
  }

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", async () => {
    // init date
    const datePicker = document.getElementById("datePicker");
    const today = new Date();
    currentDateKey = toKeyDate(today);
    datePicker.value = currentDateKey;

    // demo schedule for today – you can edit
    scheduleData[currentDateKey] = [
      { time: "10:00 – 10:30", who: "ERP & IT Team", agenda: "ERP review" },
      { time: "11:00 – 11:30", who: "Admissions Team", agenda: "Admissions status" },
      { time: "12:00 – 12:30", who: "Finance Team", agenda: "Budget review" }
    ];
    renderSchedule();

    setupRoleControls();
    setupVisitorForm();
    updateRoleUI();
    await loadAllRequests();

    datePicker.addEventListener("change", async () => {
      currentDateKey = datePicker.value;
      renderSchedule();
      renderSlots();
      renderAdminTable();
      if (currentRole === "director") {
        renderDashboard();
      }
    });
  });
</script>
</body>
</html>
